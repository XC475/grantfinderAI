generator client {
  provider      = "prisma-client-js"
  output        = "../src/generated/prisma"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
  schemas   = ["app", "public"]
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model alembic_version {
  version_num String @id(map: "alembic_version_pkc") @db.VarChar(32)

  @@schema("public")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model opportunities {
  id                          Int                           @id @default(autoincrement())
  source                      String                        @db.VarChar
  state_code                  String?                       @db.VarChar
  source_grant_id             String?                       @db.VarChar
  status                      opportunity_status_enum
  title                       String                        @db.VarChar
  description                 String?
  description_summary         String?                       @db.VarChar
  agency                      String?                       @db.VarChar
  funding_instrument          String?                       @db.VarChar
  fiscal_year                 Int?
  post_date                   DateTime?                     @db.Date
  close_date                  DateTime?                     @db.Date
  archive_date                DateTime?                     @db.Date
  cost_sharing                Boolean?
  award_max                   BigInt?
  award_min                   BigInt?
  total_funding_amount        BigInt?
  eligibility                 String?
  eligibility_summary         String?                       @db.VarChar
  last_updated                DateTime?                     @db.Timestamp(6)
  contact_name                String?                       @db.VarChar
  contact_email               String?                       @db.VarChar
  contact_phone               String?                       @db.VarChar
  url                         String?                       @db.VarChar
  attachments                 Json?                         @db.Json
  relevance_score             Int?
  raw_text                    String?
  content_hash                String?                       @db.VarChar
  funding_type                funding_type_enum?
  category                    opportunity_category_enum[]
  rfp_url                     String?                       @db.VarChar
  services                    opportunity_services_enum[]
  is_recurring                Boolean?
  application_instructions    String?
  k12_education_opportunities k12_education_opportunities[]

  @@schema("public")
}

/// ///// APP SCHEMA ////////
model User {
  id                   String                 @id @db.Uuid
  email                String                 @unique
  name                 String?
  createdAt            DateTime               @default(now())
  updatedAt            DateTime               @updatedAt
  avatarUrl            String?
  lastActiveAt         DateTime               @default(now())
  organizationId       String
  system_admin         Boolean                @default(false)
  role                 OrganizationRole       @default(MEMBER)
  onboardingCompleted  Boolean                @default(false)
  hasTemporaryPassword Boolean                @default(false)
  googleAccessToken    String?
  googleDriveConnected Boolean                @default(false)
  googleRefreshToken   String?
  googleTokenExpiry    DateTime?
  aiChats              AiChat[]
  grantBookmarks       GrantBookmark[]
  aiContextSettings    UserAIContextSettings?
  organization         Organization           @relation("UserOrganization", fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId, role])
  @@map("users")
  @@schema("app")
}

model UserAIContextSettings {
  id                        String   @id @default(cuid())
  userId                    String   @unique @db.Uuid
  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt
  enableOrgProfileChat      Boolean  @default(true)
  enableOrgProfileEditor    Boolean  @default(true)
  enableKnowledgeBaseChat   Boolean  @default(true)
  enableKnowledgeBaseEditor Boolean  @default(true)
  enableGrantSearchChat     Boolean  @default(true)
  enableGrantSearchEditor   Boolean  @default(true)
  selectedModelChat         String   @default("gpt-4o-mini")
  selectedModelEditor       String   @default("gpt-4o-mini")
  enabledModelsChat         Json?
  enabledModelsEditor       Json?
  user                      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_ai_context_settings")
  @@schema("app")
}

model Organization {
  id                     String                      @id @default(cuid())
  name                   String
  createdAt              DateTime                    @default(now())
  updatedAt              DateTime                    @updatedAt
  slug                   String                      @unique
  address                String?
  annualOperatingBudget  Decimal?                    @db.Decimal(15, 2)
  city                   String?
  email                  String?
  fiscalYearEnd          String?
  missionStatement       String?
  organizationLeaderName String?
  phone                  String?
  state                  String?
  website                String?
  zipCode                String?
  strategicPlan          String?
  logoUrl                String?
  services               opportunity_services_enum[] @default([k12_education])
  aiChats                AiChat[]
  applications           Application[]
  documents              Document[]                  @relation("OrganizationDocuments")
  folders                Folder[]                    @relation("OrganizationFolders")
  grantBookmarks         GrantBookmark[]
  eligibilityAnalyses    GrantEligibilityAnalysis[]
  recommendations        Recommendation[]
  users                  User[]                      @relation("UserOrganization")
  customFields           CustomField[]
  subscription           OrganizationSubscription?

  @@index([state])
  @@map("organizations")
  @@schema("app")
}

model CustomField {
  id             String       @id @default(cuid())
  name           String
  description    String?
  value          String
  organizationId String
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, name])
  @@index([organizationId])
  @@map("custom_fields")
  @@schema("app")
}

model GrantBookmark {
  id             String       @id @default(cuid())
  notes          String?
  createdAt      DateTime     @default(now())
  userId         String       @db.Uuid
  opportunityId  Int
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, opportunityId, organizationId])
  @@map("grant_bookmarks")
  @@schema("app")
}

model GrantEligibilityAnalysis {
  id             String         @id @default(cuid())
  matchScore     Int
  goNoGo         GoNoGoDecision
  rationale      String
  risks          String?
  confidence     Float?
  createdAt      DateTime       @default(now())
  opportunityId  Int
  organizationId String
  organization   Organization   @relation(fields: [organizationId], references: [id])

  @@unique([opportunityId, organizationId])
  @@map("grant_eligibility_analyses")
  @@schema("app")
}

model Application {
  id                      String            @id @default(cuid())
  opportunityId           Int?
  status                  ApplicationStatus @default(DRAFT)
  title                   String?
  createdAt               DateTime          @default(now())
  updatedAt               DateTime          @updatedAt
  submittedAt             DateTime?
  lastEditedAt            DateTime          @default(now())
  organizationId          String
  opportunityAgency       String?
  opportunityAttachments  Json?
  opportunityAwardMax     BigInt?
  opportunityAwardMin     BigInt?
  opportunityCloseDate    DateTime?
  opportunityDescription  String?
  opportunityEligibility  String?
  opportunityTitle        String?
  opportunityTotalFunding BigInt?
  opportunityUrl          String?
  aiChats                 AiChat[]
  organization            Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  documents               Document[]
  folder                  Folder?

  @@index([opportunityId, organizationId])
  @@index([organizationId, status])
  @@index([updatedAt])
  @@map("applications")
  @@schema("app")
}

model AiChat {
  id             String          @id @default(cuid())
  title          String?
  context        AiChatContext
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  userId         String          @db.Uuid
  applicationId  String?
  organizationId String
  metadata       Json?
  messages       AiChatMessage[]
  application    Application?    @relation(fields: [applicationId], references: [id])
  organization   Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("ai_chats")
  @@schema("app")
}

model AiChatMessage {
  id        String      @id @default(cuid())
  role      MessageRole
  content   String
  metadata  Json?
  createdAt DateTime    @default(now())
  chatId    String
  chat      AiChat      @relation(fields: [chatId], references: [id], onDelete: Cascade)

  @@map("ai_chat_messages")
  @@schema("app")
}

model Recommendation {
  id               String       @id @default(cuid())
  organizationId   String
  opportunityId    String
  fitScore         Int
  fitDescription   String
  organizationName String
  queryDate        DateTime
  createdAt        DateTime     @default(now())
  organization     Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([opportunityId])
  @@map("recommendations")
  @@schema("app")
}

model VectorDocument {
  id        BigInt                 @id @default(autoincrement())
  content   String?
  metadata  Json?
  embedding Unsupported("vector")?

  @@map("documents")
  @@schema("public")
}

model Document {
  id                  String              @id @default(cuid())
  applicationId       String?
  title               String
  content             String?
  contentType         String              @default("json")
  metadata            Json?
  version             Int                 @default(1)
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  organizationId      String
  folderId            String?
  fileSize            Int?
  fileType            String?
  fileUrl             String?
  chunkCount          Int?
  extractedText       String?
  isKnowledgeBase     Boolean             @default(true)
  vectorizationError  String?
  vectorizationStatus VectorizationStatus @default(PENDING)
  vectorizedAt        DateTime?
  fileTagId           String?
  vectors             DocumentVector[]    @relation("DocumentVectors")
  application         Application?        @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  fileTag             DocumentTag?        @relation("DocumentTags", fields: [fileTagId], references: [id])
  folder              Folder?             @relation(fields: [folderId], references: [id], onDelete: Cascade)
  organization        Organization        @relation("OrganizationDocuments", fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([applicationId])
  @@index([updatedAt])
  @@index([applicationId, createdAt])
  @@index([folderId])
  @@index([fileTagId])
  @@index([organizationId, fileTagId])
  @@index([organizationId, isKnowledgeBase])
  @@index([organizationId, fileTagId, isKnowledgeBase])
  @@index([vectorizationStatus])
  @@map("documents")
  @@schema("app")
}

model DocumentVector {
  id             BigInt                 @id @default(autoincrement())
  documentId     String                 @map("document_id")
  organizationId String                 @map("organization_id")
  chunkIndex     Int                    @map("chunk_index")
  totalChunks    Int                    @map("total_chunks")
  content        String
  embedding      Unsupported("vector")?
  fileName       String                 @map("file_name")
  fileType       String                 @map("file_type")
  contentHash    String                 @map("content_hash")
  vectorizedAt   DateTime               @default(now()) @map("vectorized_at")
  model          String                 @default("text-embedding-3-small")
  document       Document               @relation("DocumentVectors", fields: [documentId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([documentId])
  @@index([organizationId, documentId])
  @@index([embedding], map: "idx_document_vectors_embedding")
  @@map("document_vectors")
  @@schema("app")
}

model DocumentTag {
  id             String     @id @default(cuid())
  name           String
  organizationId String
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
  documents      Document[] @relation("DocumentTags")

  @@unique([organizationId, name])
  @@index([organizationId])
  @@map("document_tags")
  @@schema("app")
}

model Folder {
  id             String       @id @default(cuid())
  name           String
  organizationId String
  parentFolderId String?
  applicationId  String?      @unique
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  documents      Document[]
  application    Application? @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  organization   Organization @relation("OrganizationFolders", fields: [organizationId], references: [id], onDelete: Cascade)
  parent         Folder?      @relation("FolderHierarchy", fields: [parentFolderId], references: [id], onDelete: Cascade)
  children       Folder[]     @relation("FolderHierarchy")

  @@index([organizationId])
  @@index([parentFolderId])
  @@index([applicationId])
  @@map("folders")
  @@schema("app")
}

model OrganizationSubscription {
  id                   String             @id @default(cuid())
  organizationId       String             @unique
  tier                 SubscriptionTier   @default(FREE)
  status               SubscriptionStatus @default(ACTIVE)
  currentPeriodStart   DateTime?
  currentPeriodEnd     DateTime?
  cancelAtPeriodEnd    Boolean            @default(false)
  stripeCustomerId     String?            @unique
  stripeSubscriptionId String?            @unique
  stripePriceId        String?
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  organization         Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("organization_subscriptions")
  @@schema("app")
}

model ModelUsage {
  id             String   @id @default(cuid())
  organizationId String
  userId         String   @db.Uuid
  modelId        String
  month          Int
  year           Int
  requestCount   Int      @default(0)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@unique([organizationId, userId, modelId, month, year])
  @@index([organizationId, month, year])
  @@map("model_usage")
  @@schema("app")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model k12_education_opportunities {
  id                  Int                                       @id @default(autoincrement())
  opportunity_id      Int
  description_summary String?                                   @db.VarChar
  category            k12_education_opportunity_category_enum[]
  eligibility_summary String?                                   @db.VarChar
  relevance_score     Int?
  opportunities       opportunities                             @relation(fields: [opportunity_id], references: [id], onDelete: Cascade)

  @@schema("public")
}

enum opportunity_status_enum {
  forecasted
  posted
  closed
  archive

  @@schema("public")
}

enum GoNoGoDecision {
  GO
  NO_GO
  MAYBE

  @@schema("app")
}

enum ApplicationStatus {
  DRAFT
  IN_PROGRESS
  READY_TO_SUBMIT
  SUBMITTED
  UNDER_REVIEW
  AWARDED
  REJECTED
  WITHDRAWN

  @@schema("app")
}

enum AiChatContext {
  GENERAL
  APPLICATION
  GRANT_ANALYSIS
  DRAFTING
  ELIGIBILITY

  @@schema("app")
}

enum MessageRole {
  USER
  ASSISTANT
  SYSTEM

  @@schema("app")
}

enum OrganizationRole {
  OWNER
  ADMIN
  MEMBER

  @@schema("app")
}

enum VectorizationStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED

  @@schema("app")
}

enum SubscriptionTier {
  FREE
  STARTER
  PROFESSIONAL
  ENTERPRISE

  @@schema("app")
}

enum SubscriptionStatus {
  ACTIVE
  TRIAL
  CANCELLED
  EXPIRED

  @@schema("app")
}

enum funding_type_enum {
  state
  federal
  local
  private

  @@schema("public")
}

enum opportunity_category_enum {
  STEM_Education
  Math_and_Science_Education
  Career_and_Technical_Education
  Special_Education
  Early_Childhood_Education
  Teacher_Professional_Development
  Leadership_and_Administration_Development
  Social_Emotional_Learning
  School_Climate_and_Culture
  Bullying_Prevention
  School_Safety_and_Security
  Digital_Literacy_and_Technology
  Educational_Technology_Innovation
  After_School_Programs
  Arts_and_Music_Education
  Environmental_Education
  Health_and_Wellness
  Nutrition_and_School_Meals
  Student_Mental_Health
  Equity_and_Inclusion
  Community_Engagement
  Parental_Involvement
  College_and_Career_Readiness
  Civic_and_History_Education
  English_Language_Learners
  Financial_Literacy
  Educational_Research_and_Innovation
  Facilities_and_Infrastructure
  Data_and_Assessment_Initiatives
  Transportation_and_Accessibility
  Other

  @@schema("public")
}

enum k12_education_opportunity_category_enum {
  stem_education
  math_and_science_education
  career_and_technical_education
  special_education
  early_childhood_education
  teacher_professional_development
  leadership_and_administration_development
  social_emotional_learning
  school_climate_and_culture
  bullying_prevention
  school_safety_and_security
  digital_literacy_and_technology
  educational_technology_innovation
  after_school_programs
  arts_and_music_education
  environmental_education
  health_and_wellness
  nutrition_and_school_meals
  student_mental_health
  equity_and_inclusion
  community_engagement
  parental_involvement
  college_and_career_readiness
  civic_and_history_education
  english_language_learners
  financial_literacy
  educational_research_and_innovation
  facilities_and_infrastructure
  data_and_assessment_initiatives
  transportation_and_accessibility
  other

  @@schema("public")
}

enum opportunity_services_enum {
  k12_education
  higher_education
  non_profit
  government_agencies
  other

  @@schema("public")
}
