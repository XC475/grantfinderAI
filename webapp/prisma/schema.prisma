generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
  schemas   = ["app", "public"]
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model alembic_version {
  version_num String @id(map: "alembic_version_pkc") @db.VarChar(32)

  @@schema("public")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model opportunities {
  id                   Int                     @id @default(autoincrement())
  source               String                  @db.VarChar
  state_code           String?                 @db.VarChar
  status               opportunity_status_enum
  title                String                  @db.VarChar
  description          String?
  category             String?                 @db.VarChar
  fiscal_year          Int?
  post_date            DateTime?               @db.Date
  close_date           DateTime?               @db.Date
  total_funding_amount Int?
  eligibility          String?
  last_updated         DateTime?               @db.Timestamp(6)
  contact_name         String?                 @db.VarChar
  contact_email        String?                 @db.VarChar
  contact_phone        String?                 @db.VarChar
  url                  String?                 @db.VarChar
  extra                Json?                   @db.Json
  source_grant_id      String                  @db.VarChar
  agency               String?                 @db.VarChar
  funding_instrument   String?                 @db.VarChar
  archive_date         DateTime?               @db.Date
  cost_sharing         Boolean?
  award_max            Int?
  award_min            Int?
  eligibility_summary  String?                 @db.VarChar
  attachments          Json?                   @db.Json
  description_summary  String?                 @db.VarChar

  @@schema("public")
}

//////// APP SCHEMA ////////
model User {
  id                  String                @id @db.Uuid
  email               String                @unique
  name                String?
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt
  avatarUrl           String?
  lastActiveAt        DateTime              @default(now())
  personalWorkspaceId String                @unique
  stripeCustomerId    String?
  subscriptionStatus  String?
  subscriptionTier    String?
  trialEndsAt         DateTime?
  aiChats             AiChat[]
  grantBookmarks      GrantBookmark[]
  invitesSent         OrganizationInvite[]
  organizationMembers OrganizationMember[]
  personalWorkspace   Workspace             @relation("PersonalWorkspace", fields: [personalWorkspaceId], references: [id], onDelete: Cascade)
  role                UserRole              @default(USER)

  @@map("users")
  @@schema("app")
}

model Workspace {
  id                  String                     @id @default(cuid())
  name                String
  slug                String                     @unique
  type                WorkspaceType              @default(PERSONAL)
  createdAt           DateTime                   @default(now())
  updatedAt           DateTime                   @updatedAt
  schoolDistrictId    String?
  aiChats             AiChat[]
  grantBookmarks      GrantBookmark[]
  eligibilityAnalyses GrantEligibilityAnalysis[]
  organization        Organization?
  applications        Application[]
  personalUser        User?                      @relation("PersonalWorkspace")
  schoolDistrict      SchoolDistrict?            @relation(fields: [schoolDistrictId], references: [id], onDelete: SetNull)

  @@map("workspaces")
  @@schema("app")
}

model Organization {
  id                 String               @id @default(cuid())
  name               String
  domain             String?
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
  stripeCustomerId   String?
  subscriptionStatus String?
  subscriptionTier   String?
  trialEndsAt        DateTime?
  seatCount          Int                  @default(5)
  workspaceId        String               @unique
  invites            OrganizationInvite[]
  members            OrganizationMember[]
  workspace          Workspace            @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@map("organizations")
  @@schema("app")
}

model OrganizationMember {
  id             String           @id @default(cuid())
  role           OrganizationRole @default(MEMBER)
  joinedAt       DateTime         @default(now())
  organizationId String
  userId         String           @db.Uuid
  organization   Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, organizationId])
  @@map("organization_members")
  @@schema("app")
}

model OrganizationInvite {
  id              String           @id @default(cuid())
  email           String
  role            OrganizationRole @default(MEMBER)
  token           String           @unique
  expiresAt       DateTime
  createdAt       DateTime         @default(now())
  organizationId  String
  invitedByUserId String           @db.Uuid
  invitedBy       User             @relation(fields: [invitedByUserId], references: [id])
  organization    Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, email])
  @@map("organization_invites")
  @@schema("app")
}

model SchoolDistrict {
  id                 String      @id @default(cuid())
  leaId              String      @unique // NCES LEA ID
  name               String
  stateCode          String      // 2-letter state code
  stateLeaId         String?     // State-assigned ID
  city               String?
  zipCode            String?
  phone              String?
  latitude           Float?
  longitude          Float?
  countyName         String?
  enrollment         Int?
  numberOfSchools    Int?
  lowestGrade        Int?
  highestGrade       Int?
  urbanCentricLocale Int?
  year               Int         @default(2022)
  workspaces         Workspace[]

  @@index([stateCode])
  @@index([name])
  @@index([leaId])
  @@map("school_districts")
  @@schema("app")
}

model GrantBookmark {
  id            String    @id @default(cuid())
  notes         String?
  createdAt     DateTime  @default(now())
  workspaceId   String
  opportunityId Int       // References public.opportunities.id
  userId        String    @db.Uuid
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  workspace     Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([userId, opportunityId, workspaceId])
  @@map("grant_bookmarks")
  @@schema("app")
}

model GrantEligibilityAnalysis {
  id            String         @id @default(cuid())
  matchScore    Int
  goNoGo        GoNoGoDecision
  rationale     String
  risks         String?
  confidence    Float?
  createdAt     DateTime       @default(now())
  opportunityId Int            // References public.opportunities.id
  workspaceId   String
  workspace     Workspace      @relation(fields: [workspaceId], references: [id])

  @@unique([opportunityId, workspaceId])
  @@map("grant_eligibility_analyses")
  @@schema("app")
}

model Application {
  id           String            @id @default(cuid())
  opportunityId Int              // References public.opportunities.id
  workspaceId  String
  status       ApplicationStatus @default(DRAFT)

  // Rich text application content (Tiptap/ProseMirror JSON)
  content     Json?   // Tiptap document JSON format
  contentHtml String? // Optional: HTML version for easier display/search

  // Metadata
  title     String? // Optional custom title (defaults to grant name)
  notes     String? // Internal notes (separate from main content)
  documents Json?   // Array of uploaded document references/URLs

  // Dates & tracking
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  submittedAt  DateTime? // When it was submitted
  lastEditedAt DateTime @default(now()) // Track when content was last edited

  // Relations
  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  aiChats   AiChat[]

  @@unique([opportunityId, workspaceId])
  @@index([workspaceId, status])
  @@index([updatedAt])
  @@map("applications")
  @@schema("app")
}

model AiChat {
  id            String          @id @default(cuid())
  title         String?
  context       AiChatContext
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  workspaceId   String
  applicationId String?
  userId        String          @db.Uuid
  messages      AiChatMessage[]
  application   Application?    @relation(fields: [applicationId], references: [id])
  user          User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  workspace     Workspace       @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@map("ai_chats")
  @@schema("app")
}

model AiChatMessage {
  id        String      @id @default(cuid())
  role      MessageRole
  content   String
  metadata  Json?
  createdAt DateTime    @default(now())
  chatId    String
  chat      AiChat      @relation(fields: [chatId], references: [id], onDelete: Cascade)

  @@map("ai_chat_messages")
  @@schema("app")
}

enum opportunity_status_enum {
  forecasted
  posted
  closed
  archive

  @@schema("public")
}

enum WorkspaceType {
  PERSONAL
  ORGANIZATION

  @@schema("app")
}

enum OrganizationRole {
  OWNER
  ADMIN
  MEMBER

  @@schema("app")
}

enum GoNoGoDecision {
  GO
  NO_GO
  MAYBE

  @@schema("app")
}

enum ApplicationStatus {
  DRAFT
  IN_PROGRESS
  READY_TO_SUBMIT
  SUBMITTED
  UNDER_REVIEW
  AWARDED
  REJECTED
  WITHDRAWN

  @@schema("app")
}

enum AiChatContext {
  GENERAL
  APPLICATION
  GRANT_ANALYSIS
  DRAFTING
  ELIGIBILITY

  @@schema("app")
}

enum MessageRole {
  USER
  ASSISTANT
  SYSTEM

  @@schema("app")
}

enum UserRole {
  USER
  ADMIN

  @@schema("app")
}
